#!/bin/bash

################################################################
# Program: ngseasy_initiate_project
# Version 1.0 
# Author: Stephen Newhouse (stephen.j.newhouse@gmail.com)
#################################################################

## Set version and run date
#
NGSEASYVERSION="1.0"
RUNDATE=`date +"%d%m%y"`

###########################################################################################
## default options
###########################################################################################

config_tsv=""
project_directory=""

## global logging fuction
#
function logger_ngseasy() {
 message=${1}
 mylogfile=${2}
 echo -e [`date`]":[NGSEASY:${NGSEASYVERSION}]:"${message}":[${USER}]:[`uname -a`]" >> ${mylogfile}.log;
 echo -e [`date`]":[NGSEASY:${NGSEASYVERSION}]:"${message}":[${USER}]:[`uname -a`]"
}

## global usage
#
function ngseasy_initiate_project_usage() {
    echo "
Program: ngseasy_initiate_project
Version 1.0
Author: Stephen Newhouse (stephen.j.newhouse@gmail.com)

ngseasy_initiate_project sets up the project file directories. You only need to run this once per project

usage:   ngseasy_initiate_project -c <config_file> -d <project_directory>

options: -h  show this message
	 -c   Config pipeline file
	 -d   Base directory for [ngs_projects](fastq_raw, run_logs, config_files)
"
}

## test if docker is intsalled and exit if not
#
command -v docker >/dev/null 2>&1 || { echo -e "Docker (https://docs.docker.com/installation) not installed.\nAborting." >&2; exit 1; }
DOCKERVERSION=`docker version`
echo -e "Docker Installed:\n\n${DOCKERVERSION}\n\n"


## Check options passed in.
if test -z "$2"
then
  logger_ngseasy "[ngseasy_initiate_project]:ERROR:No options found" ${HOME}/ngseasy_logs/${RUNDATE}.NGSEASY
  ngseasy_initiate_project_usage
  exit 1
fi

#get options for command line args
while  getopts "hc:d:" opt
do

    case ${opt} in
        h)
        usage #print help
        exit 0
        ;;
        
        c)
        config_tsv=${OPTARG}
        ;;
        
        d)
        project_directory=${OPTARG}
        ;;

    esac
done

#check exists.
  if [ ! -e "${project_directory}" ] 
  then
	  echo " ${project_directory} does not exist "
	  usage;
      sleep 1s
	  exit 1;
  fi

#check exists.
  if [ ! -e "${config_tsv}" ] 
  then
	  echo " ${config_tsv} does not exist "
	  usage;
      sleep 1s
	  exit 1;
  fi

###########################################################################################
## Make log file ##
###########################################################################################

## strip path if user enters config with full path specified
#
configfile=`basename ${config_tsv}`
config_run_log="${project_directory}/run_logs/ngseasy.${NGSEASYVERSION}.${configfile}.${RUNDATE}"

if [[ ! -e "${config_run_log}.log" ]]
then
    logger_ngseasy "[ngseasy_initiate_project]:Making log file [${config_run_log}.log]"

    touch ${config_run_log}.log
    
    logger_ngseasy "[ngseasy_initiate_project]:Log file [${config_run_log}.log]"

else
    logger_ngseasy "[ngseasy_initiate_project]:Log file [${config_run_log}.log]"

fi

####################################################################################################################
## project list
# config_tsv=config_file
#
logger_ngseasy "[ngseasy_initiate_project]:CMD: awk 'NR >1 {print $5"/"$1}' ${config_tsv} | sort | uniq > ${HOME}/ngseasy_tmp/Project_list" ${config_run_log}
awk 'NR >1 {print $5"/"$1}' ${config_tsv} | sort | uniq > ${HOME}/ngseasy_tmp/Project_list

while read -f PROJECTNAME
do

    if [[ ! -d "${project_directory}/${PROJECTNAME}" ]]; then

        mkdir -p ${project_directory}/${PROJECTNAME}
        chmod -R 776 ${project_directory}/${PROJECTNAME}

        logger_ngseasy "[ngseasy_initiate_project]:Making [${project_directory}/${PROJECTNAME}] project directory" ${config_run_log}

    else 
        logger_ngseasy "[ngseasy_initiate_project]:Project directory [${project_directory}/${PROJECTNAME}] Exists" ${config_run_log}

    fi    

done < ${HOME}/ngseasy_tmp/Project_list
wait


####################################################################################################################
## sample lists
## PROJECT_DIR/PROJECT_ID/SAMPLE_ID
#
logger_ngseasy "[ngseasy_initiate_project]:CMD: awk 'NR >1 {print $5"/"$1"/"$2}' ${config_tsv} | sort | uniq > ${HOME}/ngseasy_tmp/ProjectBySample_list" ${config_run_log}

awk 'NR >1 {print $5"/"$1"/"$2}' ${config_tsv} | sort | uniq > ${HOME}/ngseasy_tmp/ProjectBySample_list
  
## Read project_list
#
while read -r f1
do

PROJECTDIRS=$f1

    if [[ ! -d "${PROJECTDIRS}" ]]
        then
        
            logger_ngseasy "[ngseasy_initiate_project]:${PROJECTDIRS} Does Not Exist" ${config_run_log}
            logger_ngseasy "[ngseasy_initiate_project]:Making Project Directories..." ${config_run_log}
            
            logger_ngseasy "[ngseasy_initiate_project]:CMD: mkdir -p ${PROJECTDIRS}" ${config_run_log}
            mkdir -p ${PROJECTDIRS}
            
            logger_ngseasy "[ngseasy_initiate_project]:CMD: mkdir -p ${PROJECTDIRS}/fastq" ${config_run_log}
            
            mkdir -p ${PROJECTDIRS}/fastq 
            
            logger_ngseasy "[ngseasy_initiate_project]:CMD: mkdir -p ${PROJECTDIRS}/tmp" ${config_run_log}
            
            mkdir -p ${PROJECTDIRS}/tmp 
            
            logger_ngseasy "[ngseasy_initiate_project]:CMD: mkdir -p ${PROJECTDIRS}/alignments" ${config_run_log}
            
            mkdir -p ${PROJECTDIRS}/alignments 
            
            logger_ngseasy "[ngseasy_initiate_project]:CMD: mkdir -p ${PROJECTDIRS}/vcf" ${config_run_log}
            
            mkdir -p ${PROJECTDIRS}/vcf 
            
            logger_ngseasy "[ngseasy_initiate_project]:CMD: mkdir -p ${PROJECTDIRS}/reports" ${config_run_log}
            
            mkdir -p ${PROJECTDIRS}/reports 
            
            logger_ngseasy "[ngseasy_initiate_project]:CMD: mkdir -p ${PROJECTDIRS}/fastq" ${config_run_log}
            mkdir -p ${PROJECTDIRS}/config_files
            
            #logger_ngseasy "[ngseasy_initiate_project]:CMD: mkdir -p ${PROJECTDIRS}/run_logs" ${HOME}/ngseasy_logs/${USER}.${RUNDATE}.NGSEASY
            #mkdir -p ${PROJECTDIRS}/run_logs            
            
        else
            logger_ngseasy "[ngseasy_initiate_project]:${PROJECTDIRS}] Exist" ${config_run_log}
    fi

done < ${HOME}/ngseasy_tmp/ProjectBySample_list
wait

## open it up to all 
chmod -R 776 ${project_directory}/

## remove lists
#
    rm ${HOME}/ngseasy_tmp/ProjectBySample_list
    rm ${HOME}/ngseasy_tmp/Project_list



