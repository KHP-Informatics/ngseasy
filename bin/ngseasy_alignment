#!/usr/bin/env bash
set -o errexit
set -o nounset
################################################################
# Program: ngseasy_alignment
# Version 1.0 
# Author: Stephen Newhouse (stephen.j.newhouse@gmail.com); Amos Folarin (amosfolarin@gmail.com)
###########################################################################################
#
#    Copyright (C) 2015  Stephen Jeffrey Newhouse
#
#    This program is free software; you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation; either version 2 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License along
#    with this program; if not, write to the Free Software Foundation, Inc.,
#    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
#
###########################################################################################

########################################################################################################
## Set version and run date
########################################################################################################
NGSEASYVERSION="1.0"
RUNDATE=`date +"%d%m%y"`
NGSEASY_STEP="ngseasy_alignment"

echo -e "\n################################################################"
echo -e "#"
echo -e "# Program: ${NGSEASY_STEP}"
echo -e "# Version ${NGSEASYVERSION}"
echo -e "# Authors: Stephen Newhouse (stephen.j.newhouse@gmail.com); Amos Folarin (amosfolarin@gmail.com)"
echo -e "#"
echo -e "# Copyright (C) 2015  Stephen Jeffrey Newhouse"
echo -e "# NGSeasy (aka ngseasy) Version ${NGSEASYVERSION} comes with ABSOLUTELY NO WARRANTY;"
echo -e "# for details see the GNU General Public License."
echo -e "# This is free software, and you are welcome to redistribute it under certain conditions;"
echo -e "# see the GNU General Public License for details."
echo -e "#"
echo -e "###########################################################################################\n\n"

#################################################################
# clear stuff up
REFDIR=""
GENOMEINDEX=""
PROJECT_ID=""
SAMPLE_ID=""
FASTQ1=""
FASTQ2=""
PROJECT_DIR=""
DNA_PREP_LIBRARY_ID=""
NGS_PLATFORM=""
NGS_TYPE=""
BAIT=""
CAPTURE=""
GENOMEBUILD=""
FASTQC=""
TRIM=""
BSQR=""
REALN=""
ALIGNER=""
VARCALLER=""
CNV=""
ANNOTATOR=""
CLEANUP=""
NCPU=""
NGSEASYVERSION=""
NGSUSER=""
RUNDATE=""
NGSEASY_STEP=""

########################################################################################################
## test if docker is intsalled and exit if not
command -v docker >/dev/null 2>&1 || { echo "I require Docker...but it's not installed.  Aborting." >&2; exit 1; }



########################################################################################################
## test if images are intsalled and exit if not
########################################################################################################
docker images | grep ngseasy-bwa 2>&1 || { echo "compbio/ngseasy-bwa:${NGSEASYVERSION} not installed.  Aborting." >&2; exit 1; }
docker images | grep ngseasy-stampy 2>&1 || { echo "compbio/ngseasy-stampy:${NGSEASYVERSION} not installed.  Aborting." >&2; exit 1; }
docker images | grep ngseasy-picardtools 2>&1 || { echo "compbio/ngseasy-picardtools:${NGSEASYVERSION} not installed.  Aborting." >&2; exit 1; }
docker images | grep ngseasy-snap 2>&1 || { echo "compbio/ngseasy-snap:${NGSEASYVERSION} not installed.  Aborting." >&2; exit 1; }
docker images | grep ngseasy-bowtie2 2>&1 || { echo "compbio/ngseasy-bowtie2:${NGSEASYVERSION} not installed.  Aborting." >&2; exit 1; }


########################################################################################################
## docker run command
########################################################################################################
DOCKER_RUN="docker run -P -w /home/pipeman -e HOME=/home/pipeman -e USER=pipeman --user pipeman"

########################################################################################################
## global logging fuction
########################################################################################################
function logger_ngseasy() {
 message=${1}
 mylogfile=${2}
 echo -e [`date`]":[NGSEASY:${NGSEASYVERSION}]:"${message}":[${USER}]:[`uname -a`]" >> ${mylogfile}.log;
 echo -e [`date`]":[NGSEASY:${NGSEASYVERSION}]:"${message}":[${USER}]:[`uname -a`]"
}

########################################################################################################
## global usage
########################################################################################################
function ngseasy_alignment_usage() {
    echo "
Program: ngseasy_alignment
Version 1.0
Author: Stephen Newhouse (stephen.j.newhouse@gmail.com)

usage:   ngseasy_alignment -c <config_file> -d <project_directory>

options:  -c  STRING	configuration file
          -d  STRING	project directory
          -h  NULL	  show this message

ngseasy_alignment sets up the NGSeasy docker containers for your aligner of choice.

This is is optomised for Illumina PE data
"
}

########################################################################################################
## check and make ~/ngseasy_logs if needed
########################################################################################################
if [[ ! -e  ${HOME}/ngseasy_logs ]]
then
  mkdir ${HOME}/ngseasy_logs
  global_run_logs="${HOME}/ngseasy_logs"
fi

########################################################################################################
## Check options passed in.
########################################################################################################
if test -z "$2"
then
  logger_ngseasy "[${NGSEASY_STEP}]:ERROR:No options found"
  ngseasy_alignment_usage
  exit 1
fi

########################################################################################################
## get options for command line args
########################################################################################################
  while  getopts "hc:d:" opt
  do

      case ${opt} in
	  h)
	  ngseasy_alignment_usage #print help
	  exit 0
	  ;;
	  
	  c)
	  config_tsv=${OPTARG}
	  ;;

	  d)
	  project_directory=${OPTARG}
	  ;; 
      esac
  done

########################################################################################################  
## check config file exists.
#
if [[ ! -e "${config_tsv}" ]] 
then
	    logger_ngseasy "[${NGSEASY_STEP}]:ERROR : [${config_tsv}] does not exist or can not be found. Exiting "
	    ngseasy_alignment_usage;
	    exit 1;
else
	    logger_ngseasy "[${NGSEASY_STEP}]:Configuration file found [${config_tsv}] "
fi

########################################################################################################
## check project_directory exists.
#
if [[ ! -d "${project_directory}" ]]
  then
    logger_ngseasy "[${NGSEASY_STEP}]:ERROR : project_directory [${project_directory}] does not exist "
    ngseasy_alignment_usage;
    exit 1;
else
	    logger_ngseasy "[${NGSEASY_STEP}]:Top Level Project Directory [${project_directory}] "
fi

########################################################################################################
## check Num feilds in  ${config_tsv}
#
logger_ngseasy "[${NGSEASY_STEP}]:Reading [${config_tsv}] "
logger_ngseasy "[${NGSEASY_STEP}]:Checking number of feilds in  [${config_tsv}] "

numcols=`awk '{ print NF }' ${config_tsv} | sort -g | head -1`

if [[  "$numcols" -lt 23 ]] 
then
      logger_ngseasy "[${NGSEASY_STEP}]:ERROR: [${config_tsv}] format issue. Check your file! "
      exit 1;
  else 
      logger_ngseasy "[${NGSEASY_STEP}]:Number of expected columns [$numcols] of [${config_tsv}] ok...proceeding... "     
fi


########################################################################################################
## Read config file 

## check ${config_tsv}. is this a batch file or the orginal config file 
#
logger_ngseasy "[${NGSEASY_STEP}]:Checking [${config_tsv}] format" ${HOME}/ngseasy_logs/ngseasy.${config_tsv}.${RUNDATE}

hasheader=`sed 1q ${config_tsv} | grep PROJECT_ID | wc -l | awk '{print $1}'`

if [[ "${config_tsv}" == *.batch.* ]]
then
  logger_ngseasy "[${NGSEASY_STEP}]:[${config_tsv}] is a BACTH file ie a subset of the original config file" ${HOME}/ngseasy_logs/ngseasy.${config_tsv}.${RUNDATE}
  RUNFILE="${config_tsv}"
  logger_ngseasy "[${NGSEASY_STEP}]:Setting RUNFILE to [${RUNFILE}]" ${HOME}/ngseasy_logs/ngseasy.${config_tsv}.${RUNDATE}
elif [[ "$hasheader" -eq 1 ]]
then
  logger_ngseasy "[${NGSEASY_STEP}]:[${config_tsv}] header present. Removing this" ${HOME}/ngseasy_logs/ngseasy.${config_tsv}.${RUNDATE}
  logger_ngseasy "[${NGSEASY_STEP}]:[cmd]:sed 1d \${config_tsv} > ${config_tsv}.tmp" ${HOME}/ngseasy_logs/ngseasy.${config_tsv}.${RUNDATE}
  sed 1d ${config_tsv} > ${config_tsv}.tmp
  RUNFILE="${config_tsv}.tmp"
  logger_ngseasy "[${NGSEASY_STEP}]:Setting RUNFILE to [${RUNFILE}]" ${HOME}/ngseasy_logs/ngseasy.${config_tsv}.${RUNDATE}
else
  RUNFILE="${config_tsv}"
  logger_ngseasy "[${NGSEASY_STEP}]:[${RUNFILE}] is seemingly perfect" ${HOME}/ngseasy_logs/ngseasy.${config_tsv}.${RUNDATE}
  logger_ngseasy "[${NGSEASY_STEP}]:Setting RUNFILE to [${RUNFILE}]" ${HOME}/ngseasy_logs/ngseasy.${config_tsv}.${RUNDATE}
fi

########################################################################################################
## Read config and loop through all lines calling aln docker
#
while read -r f1 f2 f3 f4 f5 f6 f7 f8 f9 f10 f11 f12 f13 f14 f15 f16 f17 f18 f19 f20 f21 f22 f23
do
PROJECT_ID=$f1;
SAMPLE_ID=$f2;
FASTQ1=$f3;
FASTQ2=$f4;
PROJECT_DIR=$f5;
DNA_PREP_LIBRARY_ID=$f6;
NGS_PLATFORM=$f7;
NGS_TYPE=$f8;
BAIT=$f9;
CAPTURE=$f10;
GENOMEBUILD=$f11;
FASTQC=$f12;
TRIM=$f13;
BSQR=$f14;
REALN=$f15;
ALIGNER=$f16;
VARCALLER=$f17;
CNV=$f18;
ANNOTATOR=$f19;
CLEANUP=$f20;
NCPU=$f21;
NGSEASYVERSION=$f22;
NGSUSER=$f23;
DATE=`date +"%d%m%y"`

########################################################################################################
## LOGFILE 
#

## check and make log directory
#
if [ ! -d "${PROJECT_DIR}/${PROJECT_ID}/run_logs/" ]
then
  mkdir ${PROJECT_DIR}/${PROJECT_ID}/run_logs/
fi

## LOGFILE 
#
LOGFILE="${PROJECT_DIR}/${PROJECT_ID}/run_logs/${SAMPLE_ID}.${TRIM}.${BSQR}.${REALN}.${ALIGNER}.${RUNDATE}.${NGSEASY_STEP}"
logger_ngseasy "[${NGSEASY_STEP}]:logging to [${LOGFILE}.log]"  ${LOGFILE}

## check and make logfile
#
if [ ! -e "${LOGFILE}.log" ]
then
  touch ${LOGFILE}.log
fi

## read config_file
#
logger_ngseasy "[${NGSEASY_STEP}]:Config:[$PROJECT_ID\t$SAMPLE_ID\t$FASTQ1\t$FASTQ2\t$PROJECT_DIR\t$DNA_PREP_LIBRARY_ID\t$NGS_PLATFORM\t
$NGS_TYPE\t$BAIT\t$CAPTURE\t$GENOMEBUILD\t$FASTQC\t$TRIM\t$BSQR\t$REALN\t$ALIGNER\t$VARCALLER\t$CNV\t$ANNOTATOR\t$CLEANUP\t$NCPU\t
$VERSION\t$NGSUSER]"  ${LOGFILE}
# copy config settings to dir
echo -e "$PROJECT_ID\t$SAMPLE_ID\t$FASTQ1\t$FASTQ2\t$PROJECT_DIR\t$DNA_PREP_LIBRARY_ID\t$NGS_PLATFORM\t
$NGS_TYPE\t$BAIT\t$CAPTURE\t$GENOMEBUILD\t$FASTQC\t$TRIM\t$BSQR\t$REALN\t$ALIGNER\t$VARCALLER\t$CNV\t$ANNOTATOR\t$CLEANUP\t$NCPU\t
$VERSION\t$NGSUSER" >> ${PROJECT_DIR}/${PROJECT_ID}/${SAMPLE_ID}/config_files/${SAMPLE_ID}.${TRIM}.${BSQR}.${REALN}.${ALIGNER}.${RUNDATE}.${NGSEASY_STEP}.config


########################################################################################################
## OUTPUT SAMPLE DIR 
#
SOUT="${PROJECT_DIR}/${PROJECT_ID}/${SAMPLE_ID}"
logger_ngseasy "[${NGSEASY_STEP}]:Sample Directory [${SOUT}] "

########################################################################################################
## Docker Output Dir: this is the mouned directory set by ngseasy_volumes_container
#
DOCKERHOME="/home/pipeman/ngs_projects"
logger_ngseasy "[${NGSEASY_STEP}]:Docker home directory [${DOCKERHOME}]" ${LOGFILE}

########################################################################################################
## Docker OUTPUT SAMPLE DIR 
#
SOUTDocker="${DOCKERHOME}/${PROJECT_ID}/${SAMPLE_ID}"

logger_ngseasy "[${NGSEASY_STEP}]:Docker Output directory [${SOUTDocker}]" ${LOGFILE}


########################################################################################################
## check local dir exists
#
if [ ! -d "${PROJECT_DIR}/${PROJECT_ID}/${SAMPLE_ID}" ]
then
	logger_ngseasy "[${NGSEASY_STEP}]: Cant Find Project directory. This is then end. Please Stop and check everything is ok " ${LOGFILE}
	exit 1
else 
	logger_ngseasy "[${NGSEASY_STEP}]: Setting OUTPUT directory to [${SOUT}]" ${LOGFILE}
fi

########################################################################################################
## check for fastq files exist
#
if [ ! -s "${SOUT}/fastq/${FASTQ1}" ] && [ ! -s "${SOUT}/fastq/${FASTQ2}" ]
then
	logger_ngseasy "[${NGSEASY_STEP}]: Can't Find fastq files [${SOUT}/fastq/${FASTQ1}] and [${SOUT}/fastq/${FASTQ2}] in ${SOUT}/fastq/ " ${LOGFILE}
	exit 1
fi

########################################################################################################
## Select Genome Build
#
logger_ngseasy "[${NGSEASY_STEP}]:Checking genome selected]"  ${LOGFILE}

if [[ "${GENOMEBUILD}" == "b37" ]]; then
  
  REFDIR="/home/pipeman/ngs_projects/reference_genomes_b37"
  GENOMEINDEX="${REFDIR}/human_g1k_v37"
  logger_ngseasy "[${NGSEASY_STEP}]:Genome Build [${GENOMEBUILD}]"  ${LOGFILE}
  logger_ngseasy "[${NGSEASY_STEP}]:Genome Build [${GENOMEINDEX}]"  ${LOGFILE}
  logger_ngseasy "[${NGSEASY_STEP}]:Genome Build [${REFDIR}]"  ${LOGFILE}
  sleep 1s

elif [[ "${GENOMEBUILD}" == "hg19" ]]; then

  REFDIR="/home/pipeman/ngs_projects/reference_genomes_hg19"
  GENOMEINDEX="${REFDIR}/ucsc.hg19"
  logger_ngseasy "[${NGSEASY_STEP}]:Genome Build [${GENOMEBUILD}]"  ${LOGFILE}
  logger_ngseasy "[${NGSEASY_STEP}]:Genome Build [${GENOMEINDEX}]"  ${LOGFILE}
  logger_ngseasy "[${NGSEASY_STEP}]:Genome Build [${REFDIR}]"  ${LOGFILE}
  sleep 1s

else
  logger_ngseasy "[${NGSEASY_STEP}]:No genome selected. Exiting. Choose one of [b37] or [hg19]"  ${LOGFILE}
  exit 1
fi


########################################################################################################
## check if Trimmed data alread exists and use it
#
if [ ! -s "${SOUT}/fastq/${SAMPLE_ID}.${NGS_TYPE}.${DNA_PREP_LIBRARY_ID}.${TRIM}_1.filtered.fastq.gz" ] && [ ! -s "${SOUT}/fastq/${SAMPLE_ID}.${NGS_TYPE}.${DNA_PREP_LIBRARY_ID}.${TRIM}_2.filtered.fastq.gz" ]
then
	logger_ngseasy "[${NGSEASY_STEP}]:ERROR:Trimmed FastQC Data does not exsts. Exiting" ${LOGFILE}
  logger_ngseasy "[${NGSEASY_STEP}]:Please run ngseasy_trimmomatic -c ${config_tsv} -d ${PROJECT_DIR}" ${LOGFILE}
  sleep 1s
	exit 1
else
	logger_ngseasy "[${NGSEASY_STEP}]:Trimmed FastQC Data exsts" ${LOGFILE}
	
	logger_ngseasy "[${NGSEASY_STEP}]:Setting FQ1:[${SAMPLE_ID}.${NGS_TYPE}.${DNA_PREP_LIBRARY_ID}.${TRIM}_1.filtered.fastq.gz] " ${LOGFILE}

##############
## FQ1
#
	FQ1="${SOUTDocker}/fastq/${SAMPLE_ID}.${NGS_TYPE}.${DNA_PREP_LIBRARY_ID}.${TRIM}_1.filtered.fastq.gz"
	
	logger_ngseasy "[${NGSEASY_STEP}]:Setting FQ2:[${SAMPLE_ID}.${NGS_TYPE}.${DNA_PREP_LIBRARY_ID}.${TRIM}_2.filtered.fastq.gz] " ${LOGFILE}

##############
## FQ2
#
	FQ2="${SOUTDocker}/fastq/${SAMPLE_ID}.${NGS_TYPE}.${DNA_PREP_LIBRARY_ID}.${TRIM}_2.filtered.fastq.gz"
fi

########################################################################################################
## BAM FILE NAME
#
# SAMPLE_ID.WEX.PE.ILLUMINA.atrim.bwa.b37.dupemk.bam [dupemk.${BSQR}.bam] [dupemk.${BSQR}.${REALN}.bam]
#
BAM_PREFIX="${SAMPLE_ID}.${NGS_TYPE}.${DNA_PREP_LIBRARY_ID}.${NGS_PLATFORM}.${TRIM}.${ALIGNER}.${GENOMEBUILD}"

logger_ngseasy "[${NGSEASY_STEP}]:Setting BAM prefix to [${BAM_PREFIX}] " ${LOGFILE}

########################################################################################################
# PLATFORM UNIT
#
logger_ngseasy "[${NGSEASY_STEP}]:Getting PLATFORM UNIT" ${LOGFILE}
logger_ngseasy "[${NGSEASY_STEP}]:[cmd]:platform_unit=\`zcat ${SOUT}/fastq/${FASTQ1} | head -1 | sed 's/:/\t/' - | cut -f 1 | sed 's/@//g' - \` " ${LOGFILE}

	#platform_unit=`zcat ${FQ1} | head -1 | perl -p -i -e 's/:/\t/' | cut -f 1 | perl -p -i -e 's/@//g'`  
  platform_unit=`zcat ${SOUT}/fastq/${FASTQ1} | head -1 | sed 's/:/\t/' - | cut -f 1 | sed 's/@//g' - `  

logger_ngseasy "[${NGSEASY_STEP}]:PLATFORM UNIT:[${platform_unit}]" ${LOGFILE}


########################################################################################################
#---------------------------------------ALIGNMENT------------------------------------------------------#
########################################################################################################

## check if alignmet already run and stop BAM and bed must exits and bam must be bigger than orginal fastq file
#

if [[ -e "${SOUT}/alignments/${BAM_PREFIX}.dupemk.bam" ]]  && [[ -s "${SOUT}/reports/${BAM_PREFIX}.dupemk.bed" ]]; then

  logger_ngseasy "[${NGSEASY_STEP}]:Looks like aligned BAM file already exists [${SOUT}/alignments/${BAM_PREFIX}.dupemk.bam] " ${LOGFILE}
  logger_ngseasy "[${NGSEASY_STEP}]:Skipping Alignment" ${LOGFILE}
  sleep 1s

## move on
#
elif [[ "${ALIGNER}" == "no-align" ]]; then
  logger_ngseasy "[${NGSEASY_STEP}]:Skipping Alignment. ALIGNER option [${ALIGNER}] " ${LOGFILE} 

########################################################################################################
## BWA 
#
elif [[ "${ALIGNER}" == "bwa" ]]; then
    logger_ngseasy " START Basic ${ALIGNER} Alignment " ${LOGFILE}  
# align wih bwa
  time ${DOCKER_RUN} \
  -v ${PROJECT_DIR}:/home/pipeman/ngs_projects \
  --name alignment_${BAM_PREFIX} \
  -t compbio/ngseasy-bwa:${NGSEASYVERSION} /bin/bash -c \
  "time /usr/local/bin/bwa mem \
  -M \
  -t ${NCPU} \
  -R '@RG\tID:${BAM_PREFIX}\tSM:${BAM_PREFIX}\tPU:${platform_unit}\tPL:${NGS_PLATFORM}\tLB:${DNA_PREP_LIBRARY_ID}\tDT:${RUNDATE}' \
  ${GENOMEINDEX}.fasta \
  ${FQ1} ${FQ2} | \
  samblaster --addMateTags --excludeDups \
  --discordantFile ${SOUTDocker}/alignments/${BAM_PREFIX}.discordant.sam \
  --splitterFile ${SOUTDocker}/alignments/${BAM_PREFIX}.splitread.sam \
  --unmappedFile ${SOUTDocker}/alignments/${BAM_PREFIX}.unmapped.fastq | \
  sambamba view -t ${NCPU} -S -f bam /dev/stdin | \
  sambamba sort -t ${NCPU} -m 2GB --tmpdir=${SOUTDocker}/tmp -o ${SOUTDocker}/alignments/${BAM_PREFIX}.dupemk.bam /dev/stdin && \
  sambamba index ${SOUTDocker}/alignments/${BAM_PREFIX}.dupemk.bam && \
  sambamba flagstat -t ${NCPU} ${SOUTDocker}/alignments/${BAM_PREFIX}.dupemk.bam > ${SOUTDocker}/reports/${BAM_PREFIX}.dupemk.bam.flagstat && \
  bedtools bamtobed -i ${SOUTDocker}/alignments/${BAM_PREFIX}.dupemk.bam | bedtools merge > ${SOUTDocker}/reports/${BAM_PREFIX}.dupemk.bed && \
  sambamba view -t ${NCPU} -S -f bam ${SOUTDocker}/alignments/${BAM_PREFIX}.discordant.sam | \
  sambamba sort -t ${NCPU} -m 2GB --tmpdir=${SOUTDocker}/tmp -o ${SOUTDocker}/alignments/${BAM_PREFIX}.discordant.bam /dev/stdin && \
  sambamba index ${SOUTDocker}/alignments/${BAM_PREFIX}.discordant.bam && \
  sambamba view -t ${NCPU} -S -f bam ${SOUTDocker}/alignments/${BAM_PREFIX}.splitread.sam | \
  sambamba sort -t ${NCPU} -m 2GB --tmpdir=${SOUTDocker}/tmp -o ${SOUTDocker}/alignments/${BAM_PREFIX}.splitread.bam /dev/stdin && \
  sambamba index ${SOUTDocker}/alignments/${BAM_PREFIX}.splitread.bam && \
  rm -v ${SOUTDocker}/alignments/${BAM_PREFIX}.discordant.sam && \
  rm -v ${SOUTDocker}/alignments/${BAM_PREFIX}.splitread.sam && \
  rm -rf ${SOUTDocker}/tmp/* && \
  chmod -R 777 ${SOUTDocker}/alignments/*"
  wait
  sleep 1s

# log docker run 
docker logs alignment_${BAM_PREFIX} >> ${LOGFILE}.log
docker rm -f alignment_${BAM_PREFIX}

logger_ngseasy " END Basic ${ALIGNER} Alignment " ${LOGFILE}  

########################################################################################################
## novoalign 
#
elif [[ "${ALIGNER}" == "novoalign" ]]; then

  logger_ngseasy " START Basic ${ALIGNER} Alignment " ${LOGFILE}

  time ${DOCKER_RUN} \
  --name alignment_${BAM_PREFIX} \
  -v ${PROJECT_DIR}:/home/pipeman/ngs_projects \
  -t compbio/ngseasy-novoalign:${NGSEASYVERSION} /bin/bash -c \
    "time /usr/local/bin/novoalign \
   -d ${GENOMEINDEX}.fasta.novoindex \
   -f ${FQ1} ${FQ2} \
   -F STDFQ \
   --3Prime \
   -g 40 \
   -x 6 \
   -i PE 500,100 \
   -c ${NCPU} \
   -k \
   -K ${SOUTDocker}/alignments/${BAM_PREFIX}.K.stats \
   -o SAM $'@RG\tID:${BAM_PREFIX}\tSM:${BAM_PREFIX}\tPU:${NGS_PLATFORM}\tLB:${DNA_PREP_LIBRARY_ID}' | \
  samblaster --addMateTags --excludeDups \
  --discordantFile ${SOUTDocker}/alignments/${BAM_PREFIX}.discordant.sam \
  --splitterFile ${SOUTDocker}/alignments/${BAM_PREFIX}.splitread.sam \
  --unmappedFile ${SOUTDocker}/alignments/${BAM_PREFIX}.unmapped.fastq | \
  sambamba view -t ${NCPU} -S -f bam /dev/stdin | \
  sambamba sort -t ${NCPU} -m 2GB --tmpdir=${SOUTDocker}/tmp -o ${SOUTDocker}/alignments/${BAM_PREFIX}.dupemk.bam /dev/stdin  && \
  sambamba index ${SOUTDocker}/alignments/${BAM_PREFIX}.dupemk.bam && \
  sambamba flagstat -t ${NCPU} ${SOUTDocker}/alignments/${BAM_PREFIX}.dupemk.bam > ${SOUTDocker}/reports/${BAM_PREFIX}.dupemk.bam.flagstat && \
  bedtools bamtobed -i ${SOUTDocker}/alignments/${BAM_PREFIX}.dupemk.bam | bedtools merge > ${SOUTDocker}/reports/${BAM_PREFIX}.dupemk.bed && \
  sambamba view -t ${NCPU} -S -f bam ${SOUTDocker}/alignments/${BAM_PREFIX}.discordant.sam | \
  sambamba sort -t ${NCPU} -m 2GB --tmpdir=${SOUTDocker}/tmp -o ${SOUTDocker}/alignments/${BAM_PREFIX}.discordant.bam /dev/stdin && \
  sambamba index ${SOUTDocker}/alignments/${BAM_PREFIX}.discordant.bam && \
  sambamba view -t ${NCPU} -S -f bam ${SOUTDocker}/alignments/${BAM_PREFIX}.splitread.sam | \
  sambamba sort -t ${NCPU} -m 2GB --tmpdir=${SOUTDocker}/tmp -o ${SOUTDocker}/alignments/${BAM_PREFIX}.splitread.bam /dev/stdin && \
  sambamba index ${SOUTDocker}/alignments/${BAM_PREFIX}.splitread.bam && \
  rm -v ${SOUTDocker}/alignments/${BAM_PREFIX}.discordant.sam && \
  rm -v ${SOUTDocker}/alignments/${BAM_PREFIX}.splitread.sam && \
  rm -rf ${SOUTDocker}/tmp/* && \
  chmod -R 777 ${SOUTDocker}/alignments/*"
  wait
  sleep 1s

## log docker run 
#
  docker logs alignment_${BAM_PREFIX} >> ${LOGFILE}.log
  docker rm -f alignment_${BAM_PREFIX}

  logger_ngseasy " END Basic ${ALIGNER} Alignment " ${LOGFILE}  


########################################################################################################
## stampy : bwa the stampy 
#
elif [[ "${ALIGNER}" == "stampy" ]]; then

  logger_ngseasy "[${NGSEASY_STEP}]:START Basic ${ALIGNER} Alignment" ${LOGFILE}
  logger_ngseasy "[${NGSEASY_STEP}]:Aligning with BWA before running stampy" ${LOGFILE} 

  time ${DOCKER_RUN} \
  -v ${PROJECT_DIR}:/home/pipeman/ngs_projects \
  --name alignment_${BAM_PREFIX}_bwatmp \
  -t compbio/ngseasy-bwa:${NGSEASYVERSION} /bin/bash -c \
  "time /usr/local/bin/bwa mem \
  -M \
  -t ${NCPU} \
  -R '@RG\tID:${BAM_PREFIX}\tSM:${BAM_PREFIX}\tPU:${platform_unit}\tPL:${NGS_PLATFORM}\tLB:${DNA_PREP_LIBRARY_ID}\tDT:${RUNDATE}' \
  ${GENOMEINDEX}.fasta \
  ${FQ1} ${FQ2} | \
  samblaster --addMateTags | \
  sambamba view -t ${NCPU} -S -f bam /dev/stdin | \
  sambamba sort -t ${NCPU} -m 2GB --tmpdir=${SOUTDocker}/tmp -o ${SOUTDocker}/alignments/${BAM_PREFIX}.tmp.bam /dev/stdin | \
  sambamba index ${SOUTDocker}/alignments/${BAM_PREFIX}.tmp.bam && \
  rm -rf ${SOUTDocker}/tmp/* && \
  chmod -R 777 ${SOUTDocker}/alignments/*"
  wait
  sleep 1s
  docker logs alignment_${BAM_PREFIX}_bwatmp >> ${LOGFILE}.log
  docker rm -f alignment_${BAM_PREFIX}_bwatmp

# set BWABAM
BWABAM=${SOUTDocker}/alignments/${BAM_PREFIX}.tmp.bam


## stampy on bwa aligned data
  logger_ngseasy "[${NGSEASY_STEP}]:START ${ALIGNER} Alignment on BWA Aligned BAM" ${LOGFILE}  

    time ${DOCKER_RUN} \
    --name alignment_${BAM_PREFIX} \
    -v ${PROJECT_DIR}:/home/pipeman/ngs_projects \
    -t compbio/ngseasy-stampy:${NGSEASYVERSION} /bin/bash -c \
    "time python  /usr/local/pipeline/stampy-1.0.23/stampy.py \
      -g ${GENOMEINDEX} \
      -h ${GENOMEINDEX} \
      -t ${NCPU} \
      --bamsortprefix ${SOUTDocker}/tmp \
      --bamkeepgoodreads \
      --sanger \
      --bwamark \
      --baq \
      --gapopen=40 \
      --gapextend=6 \
      --noautosense \
      --insertsize=500 \
      --insertsd=100 \
      -M ${BWABAM} | \
      samblaster --addMateTags --excludeDups \
      --discordantFile ${SOUTDocker}/alignments/${BAM_PREFIX}.discordant.sam \
      --splitterFile ${SOUTDocker}/alignments/${BAM_PREFIX}.splitread.sam \
      --unmappedFile ${SOUTDocker}/alignments/${BAM_PREFIX}.unmapped.fastq | \
      sambamba view -t ${NCPU} -S -f bam /dev/stdin | \
      sambamba sort -t ${NCPU} -m 2GB --tmpdir=${SOUTDocker}/tmp -o ${SOUTDocker}/alignments/${BAM_PREFIX}.dupemk.tmp.bam /dev/stdin && \
      sambamba index ${SOUTDocker}/alignments/${BAM_PREFIX}.dupemk.tmp.bam && \
      sambamba view -t ${NCPU} -S -f bam ${SOUTDocker}/alignments/${BAM_PREFIX}.discordant.sam | \
      sambamba sort -t ${NCPU} -m 2GB --tmpdir=${SOUTDocker}/tmp -o ${SOUTDocker}/alignments/${BAM_PREFIX}.discordant.bam /dev/stdin && \
      sambamba index ${SOUTDocker}/alignments/${BAM_PREFIX}.discordant.bam && \
      sambamba view -t ${NCPU} -S -f bam ${SOUTDocker}/alignments/${BAM_PREFIX}.splitread.sam | \
      sambamba sort -t ${NCPU} -m 2GB --tmpdir=${SOUTDocker}/tmp -o ${SOUTDocker}/alignments/${BAM_PREFIX}.splitread.bam /dev/stdin && \
      sambamba index ${SOUTDocker}/alignments/${BAM_PREFIX}.splitread.bam && \
      rm -v ${SOUTDocker}/alignments/${BAM_PREFIX}.discordant.sam && \
      rm -v ${SOUTDocker}/alignments/${BAM_PREFIX}.splitread.sam && \
      rm -rf ${SOUTDocker}/tmp/* && \
      chmod -R 777 ${SOUTDocker}/alignments/*"
      wait
      sleep 1s
      docker logs alignment_${BAM_PREFIX} >> ${LOGFILE}.log
      docker rm -f alignment_${BAM_PREFIX}
      logger_ngseasy "[${NGSEASY_STEP}]:Adding RG info to ${ALIGNER} Aligned BAM" ${LOGFILE}  

## Add RG info back to stampy and generate stats CleanSam
  time ${DOCKER_RUN} \
      --name alignmentpicard_${BAM_PREFIX} \
      -v ${PROJECT_DIR}:/home/pipeman/ngs_projects \
      -t compbio/ngseasy-picardtools:${NGSEASYVERSION} /bin/bash -c \
      "time java -Xmx12g -Djava.io.tmpdir=${SOUTDocker}/tmp -jar /usr/local/pipeline/picardtools/picard-tools-1.129/picard.jar CleanSam \
      TMP_DIR=${SOUTDocker}/tmp \
      CREATE_INDEX=FALSE \
      VALIDATION_STRINGENCY=SILENT \
      INPUT=${SOUTDocker}/alignments/${BAM_PREFIX}.dupemk.tmp.bam \
      OUTPUT=${SOUTDocker}/alignments/${BAM_PREFIX}.dupemk.tmpcleansam.bam && \
      time java -Xmx12g -Djava.io.tmpdir=${SOUTDocker}/tmp -jar /usr/local/pipeline/picardtools/picard-tools-1.129/picard.jar AddOrReplaceReadGroups \
      TMP_DIR=${SOUTDocker}/tmp \
      CREATE_INDEX=FALSE \
      VALIDATION_STRINGENCY=SILENT \
      INPUT=${SOUTDocker}/alignments/${BAM_PREFIX}.dupemk.tmpcleansam.bam \
      OUTPUT=${SOUTDocker}/alignments/${BAM_PREFIX}.dupemk.bam  \
      RGID=${BAM_PREFIX}\tSM:${BAM_PREFIX} \
      RGLB=${DNA_PREP_LIBRARY_ID} \
      RGPL=${NGS_PLATFORM} \
      RGPU=${platform_unit} \
      RGSM=${BAM_PREFIX} \
      RGDT=${RUNDATE} && \
      sambamba index ${SOUTDocker}/alignments/${BAM_PREFIX}.dupemk.bam && \
      sambamba flagstat -t ${NCPU} ${SOUTDocker}/alignments/${BAM_PREFIX}.dupemk.bam > ${SOUTDocker}/reports/${BAM_PREFIX}.dupemk.bam.flagstat && \
      bedtools bamtobed -i ${SOUTDocker}/alignments/${BAM_PREFIX}.dupemk.bam | bedtools merge > ${SOUTDocker}/reports/${BAM_PREFIX}.dupemk.bed && \
      rm -v ${SOUTDocker}/alignments/${BAM_PREFIX}.dupemk.tmpcleansam.bam && \
      rm -v ${SOUTDocker}/alignments/${BAM_PREFIX}.dupemk.tmp.bam && \
      chmod -R 777 ${SOUTDocker}/alignments/*"
      wait
      sleep 1s
## log docker run 
#
  docker logs alignmentpicard_${BAM_PREFIX} >> ${LOGFILE}.log
  docker rm -f alignmentpicard_${BAM_PREFIX}
  logger_ngseasy "[${NGSEASY_STEP}]:END Basic ${ALIGNER} Alignment " ${LOGFILE}  

########################################################################################################
# Bowtie2
# 
elif [[ "${ALIGNER}" == "bowtie2" ]]; then

# will provide options for tweaking all option in the future
FAST="--end-to-end --sensitive"
SLOW="--local --sensitive-local"

    logger_ngseasy "[${NGSEASY_STEP}]:START ${ALIGNER} Basic Alignment" ${LOGFILE}  

    time ${DOCKER_RUN} \
    --name alignment_${BAM_PREFIX} \
    -v ${PROJECT_DIR}:/home/pipeman/ngs_projects \
    -t compbio/ngseasy-bowtie2:${NGSEASYVERSION} /bin/bash -c "time /usr/local/bin/bowtie2 ${FAST} --threads ${NCPU} -x ${GENOMEINDEX} \
    -I 50 -X 10000 \
    --rg-id ${BAM_PREFIX} \
    --rg SM:${BAM_PREFIX} \
    --rg PU:${NGS_PLATFORM} \
    --rg LB:${DNA_PREP_LIBRARY_ID} \
    --rg DT:${RUNDATE} \
    -1 ${FQ1} -2 ${FQ2} | \
    samblaster --addMateTags --excludeDups \
    --discordantFile ${SOUTDocker}/alignments/${BAM_PREFIX}.discordant.sam \
    --splitterFile ${SOUTDocker}/alignments/${BAM_PREFIX}.splitread.sam \
    --unmappedFile ${SOUTDocker}/alignments/${BAM_PREFIX}.unmapped.fastq | \
    sambamba view -t ${NCPU} -S -f bam /dev/stdin | \
    sambamba sort -t ${NCPU} -m 2GB --tmpdir=${SOUTDocker}/tmp -o /${SOUTDocker}/alignments/${BAM_PREFIX}.dupemk.bam /dev/stdin && \
    sambamba index ${SOUTDocker}/alignments/${BAM_PREFIX}.dupemk.bam && \
    sambamba flagstat -t ${NCPU} ${SOUTDocker}/alignments/${BAM_PREFIX}.dupemk.bam > ${SOUTDocker}/reports/${BAM_PREFIX}.dupemk.bam.flagstat && \
    bedtools bamtobed -i ${SOUTDocker}/alignments/${BAM_PREFIX}.dupemk.bam | bedtools merge > ${SOUTDocker}/reports/${BAM_PREFIX}.dupemk.bed && \
    sambamba sort -t ${NCPU} -m 2GB --tmpdir=${SOUTDocker}/tmp -o ${SOUTDocker}/alignments/${BAM_PREFIX}.discordant.bam /dev/stdin && \
    sambamba index ${SOUTDocker}/alignments/${BAM_PREFIX}.discordant.bam && \
    sambamba view -t ${NCPU} -S -f bam ${SOUTDocker}/alignments/${BAM_PREFIX}.splitread.sam | \
    sambamba sort -t ${NCPU} -m 2GB --tmpdir=${SOUTDocker}/tmp -o ${SOUTDocker}/alignments/${BAM_PREFIX}.splitread.bam /dev/stdin && \
    sambamba index ${SOUTDocker}/alignments/${BAM_PREFIX}.splitread.bam && \
    rm -v ${SOUTDocker}/alignments/${BAM_PREFIX}.discordant.sam && \
    rm -v ${SOUTDocker}/alignments/${BAM_PREFIX}.splitread.sam && \
    rm -rf ${SOUTDocker}/tmp/* && \
    chmod -R 777 ${SOUTDocker}/alignments/*"
    wait
    sleep 1s
## log docker run 
#
  docker logs alignment_${BAM_PREFIX} >> ${LOGFILE}.log
  docker rm -f alignment_${BAM_PREFIX}
  logger_ngseasy "[${NGSEASY_STEP}]:END Basic ${ALIGNER} Basic Alignment" ${LOGFILE}  

########################################################################################################
# SNAP
# 
# align wih snap sorts and dupe marks the file anyway: but we choose to run same tools samblaster
# sambamba for consistency
#
elif [[ "${ALIGNER}" == "snap" ]]; then

logger_ngseasy "[${NGSEASY_STEP}]:START ${ALIGNER} Basic Alignment" ${LOGFILE}  

    time ${DOCKER_RUN} \
    --name alignment_${BAM_PREFIX} \
    -v ${PROJECT_DIR}:/home/pipeman/ngs_projects \
    -t compbio/ngseasy-snap:${NGSEASYVERSION} /bin/bash -c "time /usr/local/pipeline/snap/snap paired \
    ${REFDIR} \
    ${FQ1} ${FQ2} \
    -t ${NCPU} \
    -b \
    -M \
    -s 50 1000 \
    -H 300000 \
    -h 300 \
    -d 15 \
    -mcp 6000000 \
    -map \
    -pre \
    -I \
    -R '@RG\tID:${BAM_PREFIX}\tSM:${BAM_PREFIX}\tPU:${platform_unit}\tPL:${NGS_PLATFORM}\tLB:${DNA_PREP_LIBRARY_ID}\tDT:${RUNDATE}' \
    -o -sam -  | \
    samblaster --addMateTags --excludeDups \
    --discordantFile ${SOUTDocker}/alignments/${BAM_PREFIX}.discordant.sam \
    --splitterFile ${SOUTDocker}/alignments/${BAM_PREFIX}.splitread.sam \
    --unmappedFile ${SOUTDocker}/alignments/${BAM_PREFIX}.unmapped.fastq | \
    sambamba view -t ${NCPU} -S -f bam /dev/stdin | \
    sambamba sort -t ${NCPU} -m 2GB --tmpdir=${SOUTDocker}/tmp -o /${SOUTDocker}/alignments/${BAM_PREFIX}.dupemk.bam /dev/stdin && \
    sambamba index ${SOUTDocker}/alignments/${BAM_PREFIX}.dupemk.bam && \
    sambamba flagstat -t ${NCPU} ${SOUTDocker}/alignments/${BAM_PREFIX}.dupemk.bam > ${SOUTDocker}/reports/${BAM_PREFIX}.dupemk.bam.flagstat && \
    bedtools bamtobed -i ${SOUTDocker}/alignments/${BAM_PREFIX}.dupemk.bam | bedtools merge > ${SOUTDocker}/reports/${BAM_PREFIX}.dupemk.bed && \
    sambamba sort -t ${NCPU} -m 2GB --tmpdir=${SOUTDocker}/tmp -o ${SOUTDocker}/alignments/${BAM_PREFIX}.discordant.bam /dev/stdin && \
    sambamba index ${SOUTDocker}/alignments/${BAM_PREFIX}.discordant.bam && \
    sambamba view -t ${NCPU} -S -f bam ${SOUTDocker}/alignments/${BAM_PREFIX}.splitread.sam | \
    sambamba sort -t ${NCPU} -m 2GB --tmpdir=${SOUTDocker}/tmp -o ${SOUTDocker}/alignments/${BAM_PREFIX}.splitread.bam /dev/stdin && \
    sambamba index ${SOUTDocker}/alignments/${BAM_PREFIX}.splitread.bam && \
    rm -v ${SOUTDocker}/alignments/${BAM_PREFIX}.discordant.sam && \
    rm -v ${SOUTDocker}/alignments/${BAM_PREFIX}.splitread.sam && \
    rm -rf ${SOUTDocker}/tmp/* && \
    chmod -R 777 ${SOUTDocker}/alignments/*"
wait
sleep 1s
## log docker run 
#
  docker logs alignment_${BAM_PREFIX} >> ${LOGFILE}.log
  docker rm -f alignment_${BAM_PREFIX}
  logger_ngseasy " END Basic ${ALIGNER} Basic Alignment" ${LOGFILE}

## exit of no ALIGNER option is provided
#
else
  logger_ngseasy "[${NGSEASY_STEP}]:No ALIGNER option selected. Or ALIGNER option not recognised" ${LOGFILE} 
  logger_ngseasy "[${NGSEASY_STEP}]:ALIGNER Should be one of [bwa] or [stampy] or [novoalign] or [snap] or [bowtie2]" ${LOGFILE} 
  sleep 1s
  exit 1
fi

########################################################################################################
# permissions
#
#chmod -R 777 ${SOUT}/*

done < ${RUNFILE}
# THE END
